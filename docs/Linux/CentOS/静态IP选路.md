## **环境说明**

#### 准备工作

**1. 路由表**

```@Terminal
route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
default         gateway         0.0.0.0         UG    100    0        0 ens33
192.168.122.0   0.0.0.0         255.255.255.0   U     0      0        0 virbr0
192.168.174.0   0.0.0.0         255.255.255.0   U     100    0        0 ens33
```

- U 表明该路由可用。
- G 表明该路由是到一个网关。如果没有这个标志，说明和 Destination 是直连的，而相应的 Gateway 应该直接给出 Destination 的地址。
- H 表明该路由是到一个主机，如果没有该标志，说明 Destination 是一个网络，换句话说 Destination 就应该写成一个网络号和子网号的组合，而不包括主机号(主机号码处为 0)，例如 192.168.174.0
- D 表明该路由是为重定向报文创建的
- M 该路由已经被重定向报文修改

**2. IP 选路的方式**

- 首先用 IP 地址来匹配那些带 H 标志的 DestinationIP 地址。
- 如果 1 失败就匹配那些网络地址。
- 如果 2 失败就发送到 Default 网关
  顺便提一下那个 GenMask（还记得子网掩码么），它指定了目的地址的子网号，例如第一条的子网就是 174。

**3. 其他有关路由表的知识**

- 一般，我们在配置好一个网络接口的时候，一个路由就被直接创建好了。当然我们也可以手动添加路由。用 route add 命令就可以了。
- 当一个 IP 包在某一个路由器的时候发现没有路由可走，那么该路由器就会给源主机发送“主机不可达”或者“网络不可达”的 ICMP 包来报错。
- 一般的操作系统默认是没有路由功能的，这需要自己配置

**4. ICMP 的 IP 重定向报文和路由发现报文**

- 重定向报文只能由路由器发出。
- 重定向报文为主机所用，而不是为路由器所用。

**5. 动态选路协议**

- 前面的选路方法叫做静态选路，简要地说就是在配置接口的时候，以默认的方式生成路由表项。并通过 route 来增加表项，或者通过 ICMP 报文来更新表项（通常在默认方式出错的情况下）。 而如果上诉三种方法都不能满足，那么我们就使用动态选路。
  动态选路协议是用于动态选路的重要组成部分，但是他们只是使用在路由器之间，相邻路由器之间互相通信。系统（路有选择程序）选择比较合适的路由放到核心路由表中，然后系统就可以根据这个核心路有表找到最合适的网路。也就是说，动态选路是在系统核心网络外部进行的，它只是用一些选路的策略影响路由表，而不会影响到最后通过路由表选择路由的那一部分。选路协议有一大类常用的叫做内部网关协议(IGP)，而在 IGP 中，RIP 就是其中最重要的协议。一种新的 IGP 协议叫做开放最短路经优先(OSPF)协议，其意在取代 RIP。另一种最早用在网路骨干网上的 IGP 协议--HELLO，现在已经不用了。
  如今，任何支持动态选路的路由器都必须同时支持 OSPF 和 RIP，还可以选择性的支持其他的 IGP 协议。

**6. Unix 选路程序**

- Unix 系统上面通常都有路由守护程序－－routed。还有一个叫做 gate。gate 所支持的协议要比 routed 多，routed 只是支持 RIPv1 版本。而 gate 则支持 RIPv1、v2，BGPv1 等等。

**7. RIP(选路信息协议)**

- 它的定义可以在 RFC1058 内找到，这种协议使用 UDP 作为载体（也就是 UDP 的上层协议）。我们最关心的就是 RIP 其中的一个段，叫做度量的段，这是一个以 hop 作为计数器（就是以走过多少路由为计数器）的段（IP 协议里面也有一个 TTL 不是么）。这个度量段将最终影响到路由表的建立。
- 一般说来 routed 要承担如下的工作：
  7.1 给每一个已知的路由器发送 rip 请求报文，要求其他路由器给出完整的路由表。这种报文的命令字段为 1，地址字段为 0，度量地段为 16（相当于无穷大）。
  7.2 接受请求，如果接收到刚才的那个请求，就把自己的完整的路由表交给请求者。如果没有，就处理 IP 请求表项，把表项中自己有的部分添上跳数，没有的部分添上 16。然后发给请求者。
  7.3 接受回应。更新自己的路由表。使用 hop 数小的规则。
  7.4 定期更新路由表，一般是 30s(真频繁)给相邻的路有启发一次自己的路由表。这种形式可以使广播形式的。

## **注意事项**
